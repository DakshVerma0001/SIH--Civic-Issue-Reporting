<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Civic Issue Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 p-6">

  <form action="/post" method="post" enctype="multipart/form-data"
        class="bg-white p-6 rounded-xl shadow-md max-w-md mx-auto space-y-4">
        
    <h1 class="text-2xl font-bold text-center">Report Civic Issue</h1>

    <!-- Title -->
    <input type="text" name="title" placeholder="Enter title"
      class="border p-2 rounded w-full" required />

    <!-- Description -->
    <textarea name="description" placeholder="Enter your problem!"
      class="border p-2 rounded w-full" required></textarea>

    <!-- Hidden fields -->
    <input type="hidden" name="location" id="location">
    <input type="hidden" name="latitude" id="latitude">
    <input type="hidden" name="longitude" id="longitude">
    <input type="hidden" name="timestamp" id="timestamp">

    <!-- Manual Location -->
    <div>
      <label class="block font-semibold mb-1">Enter location manually:</label>
      <input type="text" id="manualLocation" name="manualLocation"
        placeholder="Enter location" class="border p-2 rounded w-full">
    </div>

    <!-- Auto Location -->
    <button type="button" onclick="getLocation()"
      class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
      üìç Use My Location
    </button>

    <!-- Photo Section -->
    <div id="photoSection">
      <label class="block font-semibold mt-3 mb-1">Upload or Capture Photo:</label>

      <!-- Upload -->
      <input type="file" id="uploadImage" name="image" accept="image/*"
        class="border p-2 rounded w-full mb-2">

      <!-- Capture (only shown on mobile) -->
      <button type="button" id="captureBtn"
        class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 w-full hidden">
        üé• Capture Live Photo
      </button>

      <!-- Live camera -->
      <video id="video" class="hidden w-full mt-2 rounded" autoplay></video>
      <canvas id="canvas" class="hidden"></canvas>
      <img id="preview" class="hidden mt-3 rounded shadow-lg">
      <p id="timeDisplay" class="text-gray-600 text-sm mt-1 hidden"></p>
    </div>

    <!-- Submit -->
    <input type="submit" value="Submit Issue"
      class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 w-full">
  </form>

  <!-- JAVASCRIPT SECTION -->
  <script>
    /* ------------------------- GET USER LOCATION -------------------------- */
    async function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lon;

            try {
              const res = await fetch(`/reverse-geocode?lat=${lat}&lon=${lon}`);
              const data = await res.json();

              const loc = data.display_name || `${lat}, ${lon}`;
              document.getElementById("location").value = loc;
              document.getElementById("manualLocation").value = loc;

            } catch (err) {
              console.error("Reverse geocoding failed:", err);
              document.getElementById("location").value = `${lat}, ${lon}`;
              document.getElementById("manualLocation").value = `${lat}, ${lon}`;
            }
          },
          () => alert("Location access denied. Please type manually."),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      } else {
        alert("Geolocation not supported.");
      }
    }

    /* ------------------------- WATERMARK + TIMESTAMP ---------------------- */
    function addWatermarkToCanvas(canvas, ctx) {
      const now = new Date();
      const timestamp = now.toLocaleString();

      document.getElementById("timestamp").value = timestamp;
      document.getElementById("timeDisplay").innerText = "üìÖ Captured on: " + timestamp;
      document.getElementById("timeDisplay").classList.remove("hidden");

      ctx.font = "18px Arial";
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      ctx.fillRect(canvas.width - 250, canvas.height - 35, 240, 28);

      ctx.fillStyle = "black";
      ctx.fillText(timestamp, canvas.width - 240, canvas.height - 15);
    }

    /* ------------------------- UPLOAD + WATERMARK -------------------------- */
    const uploadInput = document.getElementById("uploadImage");
    const preview = document.getElementById("preview");

    uploadInput.addEventListener("change", () => {
      const file = uploadInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {

          const canvas = document.getElementById("canvas");
          const ctx = canvas.getContext("2d");

          canvas.width = img.width;
          canvas.height = img.height;

          ctx.drawImage(img, 0, 0);
          addWatermarkToCanvas(canvas, ctx);

          canvas.toBlob((blob) => {
            const fileWithWatermark = new File([blob], "photo_with_watermark.png", { type: "image/png" });
            const dt = new DataTransfer();
            dt.items.add(fileWithWatermark);
            uploadInput.files = dt.files;

            preview.src = URL.createObjectURL(fileWithWatermark);
            preview.classList.remove("hidden");
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    /* ------------------------- CAPTURE LIVE PHOTO -------------------------- */
    const captureBtn = document.getElementById("captureBtn");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");

    captureBtn.addEventListener("click", async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Camera not supported on this device.");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      video.classList.remove("hidden");

      alert("üì∏ Tap on the video to capture photo");

      video.addEventListener("click", () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        // STOP camera
        stream.getTracks().forEach(t => t.stop());
        video.classList.add("hidden");

        addWatermarkToCanvas(canvas, ctx);

        canvas.toBlob((blob) => {
          const file = new File([blob], "captured_with_watermark.png", { type: "image/png" });
          const dt = new DataTransfer();
          dt.items.add(file);
          uploadInput.files = dt.files;

          preview.src = URL.createObjectURL(file);
          preview.classList.remove("hidden");
        });
      });
    });

    /* -------- Show capture button ONLY on mobile ------------ */
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
      document.getElementById("captureBtn").classList.remove("hidden");
      uploadInput.setAttribute("capture", "environment");
    }
  </script>

</body>
</html>
