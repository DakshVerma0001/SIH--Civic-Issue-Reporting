<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: url('/images/uploads/backImg.jpg') no-repeat center center fixed;
      background-size: 100% 100%;
      margin: 0;
      min-height: 100vh;
      color: #183443;
      overflow-x: hidden;
    }
    .dashboard-outer {
      width: 100vw;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 32px;
    }
    .stats-container, .issues-container {
      width: 1120px;
      max-width: 98vw;
      margin: 0 auto;
      border-radius: 32px;
      box-shadow: 0 8px 34px 4px rgba(32,120,180,.09);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stats-container {
      background: rgba(198, 245, 200, 0.94); 
      padding: 20px 38px 16px 38px;
      min-height: 100px;
      position: relative;
    }
    .dashboard-heading {
      width: 100%;
      max-width: 350px;
      margin: 0 auto 20px auto;
      font-size: 2.2em;
      font-weight: 900;
      color: #2a6ed7;
      letter-spacing: 1.22px;
      text-align: center;
      text-shadow: 0 2px 10px rgba(30,120,240,0.09);
      padding-top: 1px;
    }
    /* Stat grid spanning full width */
    .stats-row {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 22px;
      justify-content: center;
      margin: 0 auto 13px auto;
      align-items: stretch;
    }
    .stat-card {
      border-radius: 14px;
      background:  #033509;
      font-size: 15.7px;
      font-weight: 700;
      color: #e2ece9;
      padding: 14px 0 10px 0;
      text-align: center;
      box-shadow: 0 2.5px 7px rgba(70,160,130,0.09);
      border: 1px solid #d7eefa;
      min-width: 0;
      width: 80%;
      letter-spacing: 0.06em;
      line-height: 1.21;
      transition: background 0.12s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .stat-card span {
      font-size: 23.5px;
      color: #2793fa;
      font-weight: 900;
      display: block;
      margin-top: 1.7px;
    }
    .actions {
      margin-top: 13px;
      gap: 19px;
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .actions a {
      padding: 12px 28px;
      font-size: 15px;
      border-radius: 8px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(95deg, #136d17 82%, #011d41 120%);
      text-decoration: none;
      box-shadow: 0 2px 10px rgba(30,120,220,0.08);
      transition: filter .11s;
      display: flex; align-items: center; border: none;
      margin-right: 3px;
    }
    .actions .excel-btn {background: linear-gradient(98deg, #256be2 60%, #5bc8f7 120%);}
    .actions a:hover { filter: brightness(1.09);}
    /* Issues Container - greenish */
    .issues-container {
      background: rgba(216, 241, 183, 0.97);  /* green shade */
      padding: 37px 50px 32px 50px;
      min-height: 340px;
    }
    .issues-grid {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 36px 30px;
      margin-top: 2px;
      margin-bottom: 0;
    }
    .issue-card {
      background: #fff;
      border-radius: 21px;
      box-shadow: 0 6px 24px rgba(30,150,50,0.13);
      padding: 24px 21px 13px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1.5px solid #defde5;
      align-items: flex-start;
      min-width: 0;
      min-height: 370px;
      position:relative;
      transition: box-shadow 0.14s;
    }
    .issue-card img {
      width: 100%;
      height: 125px;
      object-fit: cover;
      border-radius: 15px;
      margin-bottom: 6px;
      box-shadow: 0 2px 6px rgba(33,150,243,0.10);
    }
    .issue-card h4 {
      font-size: 1.13em;
      font-weight: 700;
      color: #074c96;
      margin: 3px 0 2px 0;
      letter-spacing: 0.19px;
      display: block;
      line-height: 1.34;
    }
    .section-label {
      color: #073f17;
      font-size: 15px;
      font-weight: 700;
      margin: 5px 0 6px 0;
    }
    .issue-details p {
      margin: 7px 0 0 0;
      font-size: 15.2px;
      font-weight: 400;
      color: #25404f;
      line-height: 1.58;
      letter-spacing: .03em;
      display: block;
    }
    .issue-details strong {
      color: #073f17;
      font-weight: 700;
      margin-bottom: 1.5px;
      font-size: 15.6px;
    }
    .issue-details em {
      color: #050505;
      font-size: .99em;
      
    }
    .meta-block {
      margin-top: 4px;
      margin-bottom: 6px;
      font-size: 14.5px;
    }
    .issue-actions {
      display: flex;
      gap: 7px;
      margin-top: 11px;
    }
    .btn {
      padding: 8px 15px; border: none; border-radius: 7px;
      font-size: 14px; color: #fff; font-weight: 600;
      cursor: pointer;
      outline: none;
      background: linear-gradient(90deg,#10bc6d 74%, #2770c4 100%);
      transition: filter 0.15s;
      letter-spacing: .46px;
    }
    .btn-success { background: linear-gradient(90deg, #43a047 74%, #7be1a4 100%);}
    .btn-danger  { background: linear-gradient(90deg, #e53935 67%, #facfc7 100%);}
    .btn-primary { background: linear-gradient(90deg, #1565c0 73%, #bcbefa 100%);}
    .btn:hover { filter: brightness(1.13);}
    @media (max-width:1170px){
      .dashboard-outer,.stats-container,.issues-container { width:100vw; }
      .stats-container,.issues-container { max-width:100vw; }
    }
    @media (max-width:900px){
      .stats-container,.issues-container{padding:11px 2vw;}
      .issues-grid {grid-template-columns:1fr 1fr;gap:18px 8px;}
      .issue-card {min-height: 280px;}
      .dashboard-heading{font-size:1.3em;}
      .stats-row{gap:11px;}
    }
    @media (max-width:700px){
      .issues-grid {grid-template-columns:1fr;}
      .issue-card{padding:10px 5px;}
      .stats-row{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div class="dashboard-outer">

  <!-- First Container (Admin + Stats + Download) -->
  <div class="stats-container">
    <div class="dashboard-heading">Admin Dashboard</div>
    <div class="stats-row">
      <div class="stat-card">Total <span><%= counts.total %></span></div>
      <div class="stat-card">Pending <span><%= counts.pending %></span></div>
      <div class="stat-card">Approved <span><%= counts.approved %></span></div>
      <div class="stat-card">Resolved <span><%= counts.resolved %></span></div>
      <div class="stat-card">Rejected <span><%= counts.rejected %></span></div>
    </div>
    <div class="actions">
      <a href="/admin/export/csv" class="csv-btn">â¬‡ Download CSV</a>
      <a href="/admin/export/excel" class="excel-btn">â¬‡ Download Excel</a>
    </div>
  </div>

  <!-- Second Container (Issues Grid) -->
  <div class="issues-container">
    <div class="issues-grid">
      <% 
      if (issues && issues.length > 0) { 
        for(let idx=0; idx<issues.length; idx++){  
          let i = issues[idx];
      %>
      <div class="issue-card">
        <% if(i.image){ %>
          <img src="<%= i.image %>" alt="Issue Photo">
        <% } %>
        <h4><%= i.title %></h4>
        <div class="section-label"><b>GENERAL INFORMATION</b></div>
        <div class="issue-details">
          <p><strong>Description:</strong> <%= i.description %></p>
          <div class="meta-block"><strong>Status:</strong> <%= i.status %></div>
          <div class="meta-block"><strong>Priority:</strong> <em><%= i.priority || "N/A" %></em></div>
          <div class="meta-block"><strong>Category:</strong> <em><%= i.category || "N/A" %></em></div>
          <% if(i.location){ %>
            <div class="meta-block"><strong>Location:</strong> <em><%= i.location %></em></div>
          <% } %>
          <% if(i.createdAt){ %>
            <div class="meta-block"><strong>Date & Time:</strong> <em><%= new Date(i.createdAt).toLocaleString() %></em></div>
          <% } %>
        </div>
        <% if(i.status === 'pending'){ %>
          <div class="issue-actions">
            <form action="/admin/issue/<%= i._id %>/approve" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-success">Approve</button>
            </form>
            <form action="/admin/issue/<%= i._id %>/reject" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-danger">Reject</button>
            </form>
          </div>
        <% } else if(i.status === 'approved'){ %>
          <div class="issue-actions">
            <button type="button" class="btn btn-primary" onclick="openResolvePopup('<%= i._id %>')">Resolve</button>
          </div>
        <% } %>
      </div>
      <% } } else { %>
        <p style="text-align:center; font-size:16px;">No issues found.</p>
      <% } %>
    </div>
  </div>
</div>
<!-- Popup, JS, etc. unchanged -->
<div id="resolvePopup" 
     style="display:none; position:fixed; inset:0; background:#00000070; backdrop-filter:blur(5px); 
            justify-content:center; align-items:center; z-index:999;">
  <div id="popupBox" style="background:linear-gradient(135deg,#fff,#eef1fa 66%); border-radius:24px;box-shadow:0 10px 25px rgba(0,0,0,0.22);padding:33px 27px 29px;width:407px;text-align:center;animation:scaleUp 0.3s ease-in-out forwards;">
    <h2>ðŸ“¸ Upload Live Resolved Photo</h2>
    <p>Please capture a live photo confirming this issue is resolved.</p>
    <button onclick="captureAndResolve()" class="submitBtn">ðŸ“¸ Capture Live Photo</button>
    <button onclick="closePopup()" class="cancelBtn">Cancel</button>
    <video id="cameraFeed" autoplay playsinline></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>
    <input type="hidden" id="resolvedData">
    <input type="hidden" id="resolveIssueId">
    <input type="hidden" id="adminLat">
    <input type="hidden" id="adminLon">
    <input type="hidden" id="adminTime">
  </div>
</div>
<script>
let stream;
function openResolvePopup(issueId) {
  document.getElementById("resolveIssueId").value = issueId;
  document.getElementById("resolvePopup").style.display = "flex";
  const video = document.getElementById("cameraFeed");
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(s => { stream = s; video.srcObject = stream; })
    .catch(() => alert("Camera permission required"));
}
function closePopup() {
  document.getElementById("resolvePopup").style.display = "none";
  if (stream) { stream.getTracks().forEach(track => track.stop()); }
}
async function captureAndResolve() {
  const issueId = document.getElementById("resolveIssueId").value;
  const video = document.getElementById("cameraFeed");
  const canvas = document.getElementById("photoCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  const imageData = canvas.toDataURL("image/jpeg");
  let res = await fetch(`/admin/resolve/${issueId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ resolvedImage: imageData })
  });
  let data = await res.json();
  if (data.success) {
    alert("âœ… Issue resolved successfully & email sent!");
    closePopup();
    location.reload();
  } else {
    alert("Upload failed! " + data.msg);
  }
}
</script>
</body>
</html>
